angular.module("mwFormUtils",["mwFormUtils.responseUtils"]),angular.module("mwFormUtils.responseUtils",[]).factory("mwFormResponseUtils",function(){var e={},t=["text","textarea","number","date","time","email","range","url","star"];return e.$getObjectByIdMap=function(e,t){var r={};return e?(e.forEach(function(e){var i=e;t&&(i=t(e)),r[e.id]=i}),r):r},e.$getOfferedAnswerByIdMap=function(t){return e.$getObjectByIdMap(t.offeredAnswers,function(e){return{id:e.id,value:e.value}})},e.$extractResponseForQuestionWithOfferedAnswers=function(t,r){var i=e.$getOfferedAnswerByIdMap(t),n={};return r.selectedAnswers?(n.selectedAnswers=[],r.selectedAnswers.forEach(function(e){n.selectedAnswers.push(i[e])})):r.selectedAnswer&&(n.selectedAnswer=i[r.selectedAnswer]),r.other&&(n.other=r.other),n},e.$extractResponseForPriorityQuestion=function(t,r){var i=[];if(!r.priorityList)return i;var n=e.$getObjectByIdMap(t.priorityList);return r.priorityList.forEach(function(e){var t=n[e.id];i.push({id:t.id,value:t.value,priority:e.priority})}),i},e.$extractResponseForDivisionQuestion=function(t,r){var i=[],n=e.$getObjectByIdMap(t.divisionList);return Object.getOwnPropertyNames(r).forEach(function(e){var t=r[e],o=n[e];o&&i.push({id:o.id,label:o.value,value:t})}),i},e.$extractResponseForGridQuestion=function(t,r){if(!t.grid||!t.grid.rows)return i;if("radio"==t.grid.cellInputType)return e.$extractResponseForRadioGridQuestion(t,r);var i=[];return t.grid.rows.forEach(function(e){t.grid.cols.forEach(function(n){var o={row:{id:e.id,label:e.label},col:{id:n.id,label:n.label},value:null};if(r.hasOwnProperty(e.id)&&r[e.id].hasOwnProperty(n.id)){var s=r[e.id][n.id];"date"==t.grid.cellInputType&&s instanceof Date?o.value=s.toLocaleDateString():"time"==t.grid.cellInputType&&s instanceof Date?o.value=s.toLocaleTimeString():o.value=s}i.push(o)})}),i},e.$extractResponseForRadioGridQuestion=function(t,r){var i=[],n=e.$getObjectByIdMap(t.grid.cols);return t.grid.rows.forEach(function(e){var t=r[e.id],o=null;t&&(o=n[t]);var s={row:{id:e.id,label:e.label},col:null};o&&(s.col={id:o.id,label:o.label}),i.push(s)}),i},e.extractResponse=function(r,i){return t.indexOf(r.type)!==-1?i.answer:"radio"==r.type||"checkbox"==r.type||"select"==r.type?e.$extractResponseForQuestionWithOfferedAnswers(r,i):"grid"==r.type?e.$extractResponseForGridQuestion(r,i):"priority"==r.type?e.$extractResponseForPriorityQuestion(r,i):"division"==r.type?e.$extractResponseForDivisionQuestion(r,i):null},e.mergeFormWithResponse=function(t,r){var i={};return angular.copy(t,i),i.pages.forEach(function(t){t.elements.forEach(function(t){var i=t.question;if(i){var n=r[i.id];n&&(i.response=e.extractResponse(i,n))}})}),i},e.getQuestionList=function(e,t){var r=[];return e.pages.forEach(function(e){e.elements.forEach(function(e){if(e.question){var i=e.question;t&&(i={},angular.copy(e.question,i)),r.push(i)}})}),r},e.getQuestionWithResponseList=function(t,r){var i=[];return e.getQuestionList(t,!0).forEach(function(t){var n=r[t.id];n?t.response=e.extractResponse(t,n):t.response=null,i.push(t)}),i},e.$$getHeader=function(e,t,r,i,n){var o="";return n&&((e||0===e)&&(o+=e+"."),null!==r&&void 0!==r&&(Array.isArray(r)||(r=[r]),r.forEach(function(e){o+=e+"."})),o.length&&(o+=" ")),o+=t,null===i||void 0===i?o:(Array.isArray(i)||(i=[i]),i.forEach(function(e){o+=" ["+e+"]"}),o)},e.getResponseSheetHeaders=function(t,r){var i=["grid","priority","division"],n=[],o=0;return e.getQuestionList(t).forEach(function(t){o++;var s=1;if(i.indexOf(t.type)===-1)n.push(e.$$getHeader(o,t.text,null,null,r));else if("grid"==t.type){if(!t.grid)return;"radio"==t.grid.cellInputType?t.grid.rows.forEach(function(i){n.push(e.$$getHeader(o,t.text,s,i.label,r)),s++}):t.grid.rows.forEach(function(i,a){t.grid.cols.forEach(function(u,c){n.push(e.$$getHeader(o,t.text,[a+1,c+1],[i.label,u.label],r)),s++})})}else if("priority"==t.type){if(!t.priorityList)return;t.priorityList.forEach(function(i){n.push(e.$$getHeader(o,t.text,s,i.value,r)),s++})}else if("division"==t.type){if(!t.divisionList)return;t.divisionList.forEach(function(i){n.push(e.$$getHeader(o,t.text,s,i.value,r)),s++})}}),n},e.getResponseSheetRow=function(t,r){var i="; ",n=[];if(!r)return n;for(var o=e.getQuestionWithResponseList(t,r),s=["radio","checkbox","select","grid","priority","division"],a=0;a<o.length;a++){var u=o[a],c=u.response;if(s.indexOf(u.type)!==-1){if("radio"==u.type||"select"==u.type){if(!c){n.push("");continue}var l="";c.selectedAnswer&&(l=c.selectedAnswer.value),c.other&&(l&&(l+=i),l+=c.other),n.push(l)}else if("checkbox"==u.type){if(!c||!c.selectedAnswers){n.push("");continue}var l="";c.selectedAnswers.forEach(function(e){l&&(l+=i),l+=e.value}),c.other&&(l&&(l+=i),l+=c.other),n.push(l)}else if("grid"==u.type){if(!u.grid)continue;if(!c){"radio"==u.grid.cellInputType?u.grid.rows.forEach(function(){n.push("")}):u.grid.rows.forEach(function(){u.grid.cols.forEach(function(){n.push("")})});continue}"radio"==u.grid.cellInputType?c.forEach(function(e){n.push(e.col?e.col.label:"")}):c.forEach(function(e){n.push(e.value)})}else if("priority"==u.type){if(!u.priorityList)continue;var f=e.$getObjectByIdMap(c);u.priorityList.forEach(function(e){var t=f[e.id];t?n.push(t.priority):n.push("")})}else if("division"==u.type){if(!u.divisionList)continue;var p=e.$getObjectByIdMap(c);u.divisionList.forEach(function(e){var t=p[e.id];t?n.push(t.value):n.push("")})}}else n.push(c?c:"")}return n},e.getResponseSheetRows=function(t,r){return r.map(function(r){return e.getResponseSheetRow(t,r)})},e.getResponseSheet=function(t,r,i){var n=[],o=e.getResponseSheetHeaders(t,i);return n.push(o),r?(r instanceof Array?r.forEach(function(r){n.push(e.getResponseSheetRow(t,r))}):n.push(e.getResponseSheetRow(t,r)),n):n},e});